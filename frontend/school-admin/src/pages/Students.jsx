import React, { useEffect, useState } from "react";
import { Link, useNavigate } from "react-router-dom";
import { 
  FaHome, FaFileAlt, FaChalkboardTeacher, FaCog, 
  FaSignOutAlt, FaBell, FaFacebookMessenger, FaSearch, FaCalendarAlt, FaCommentDots 
} from "react-icons/fa";
import axios from "axios";
import { format, parseISO, startOfWeek, startOfMonth } from "date-fns";
import { useMemo } from "react";
import { getDatabase, ref, onValue, push, update } from "firebase/database";
import { getFirestore, collection, getDocs } from "firebase/firestore";

import app, { db } from "../firebase"; // Adjust the path if needed


function StudentsPage() {
  // ------------------ STATES ------------------
  const [students, setStudents] = useState([]); // List of all students
  const [selectedGrade, setSelectedGrade] = useState("All"); // Grade filter
  const [selectedSection, setSelectedSection] = useState("All"); // Section filter
  const [sections, setSections] = useState([]); // Sections available for selected grade
  const [selectedStudent, setSelectedStudent] = useState(null); // Currently selected student
  const [studentChatOpen, setStudentChatOpen] = useState(false); // Toggle chat popup
  const [popupMessages, setPopupMessages] = useState([]); // Messages for chat popup
  const [popupInput, setPopupInput] = useState(""); // Input for chat message
  const [details, setDetails] = useState(null);
  const [performance, setPerformance] = useState([]);
  const [studentTab, setStudentTab] = useState("details");
  const [attendance, setAttendance] = useState([]);
  const [marks, setMarks] = useState({});
  const [loading, setLoading] = useState(true);
  const [unreadMap, setUnreadMap] = useState({});
  const navigate = useNavigate();
  const admin = JSON.parse(localStorage.getItem("admin")) || {}; // Admin info from localStorage
 
const [studentMarks, setStudentMarks] = useState({});
const [attendanceView, setAttendanceView] = useState("daily");
const [attendanceCourseFilter, setAttendanceCourseFilter] = useState("All");
const [expandedCards, setExpandedCards] = useState({});

  const [teachers, setTeachers] = useState([]);
const [unreadTeachers, setUnreadTeachers] = useState({});
const [unreadSenders, setUnreadSenders] = useState([]); 
const [showMessageDropdown, setShowMessageDropdown] = useState(false);
const [selectedTeacher, setSelectedTeacher] = useState(null);
const [teacherChatOpen, setTeacherChatOpen] = useState(false);
const [postNotifications, setPostNotifications] = useState([]);
const [showPostDropdown, setShowPostDropdown] = useState(false);
 const [newMessageText, setNewMessageText] = useState("");
const [lastMessages, setLastMessages] = useState({});
// At the top of your StudentsPage component
const [expandedSubjects, setExpandedSubjects] = useState([]); 

const adminId = admin.userId;


const adminUserId = admin.userId;

const db = getDatabase(app);


const fetchPostNotifications = async () => {
  try {
    const res = await axios.get(
      `http://127.0.0.1:5000/api/get_post_notifications/${adminId}`
    );

    const notifications = (res.data || []).map(n => ({
      ...n,
      notificationId: n.notificationId || n.id
    }));

    setPostNotifications(notifications);
  } catch (err) {
    console.error("Post notification fetch failed", err);
  }
};



useEffect(() => {
  if (!adminId) return;

  fetchPostNotifications();
  const interval = setInterval(fetchPostNotifications, 5000);

  return () => clearInterval(interval);
}, [adminId]);

const handleNotificationClick = async (notification) => {
  // Mark as read in backend
  await axios.post(
    "http://127.0.0.1:5000/api/mark_post_notification_read",
    { notificationId: notification.notificationId }
  );

  // Remove from UI
  setPostNotifications(prev =>
    prev.filter(n => n.notificationId !== notification.notificationId)
  );

  setShowPostDropdown(false);

  // Navigate to dashboard with postId
  navigate("/dashboard", {
    state: { postId: notification.postId }
  });
};

 const handleSendMessage = () => {
    // now newMessageText is defined
    console.log("Sending message:", newMessageText);
    // your code to send the message
  };

useEffect(() => {
  const closeDropdown = (e) => {
    if (
      !e.target.closest(".icon-circle") &&
      !e.target.closest(".notification-dropdown")
    ) {
      setShowPostDropdown(false);
    }
  };

  document.addEventListener("click", closeDropdown);
  return () => document.removeEventListener("click", closeDropdown);
}, []);




useEffect(() => {
  const fetchStudents = async () => {
    const querySnapshot = await getDocs(collection(db, "students"));
    const studentsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    setStudents(studentsData);
  };

  fetchStudents();
}, []);


const handleClick = () => {
    navigate("/all-chat"); // replace with your target route
  };

useEffect(() => {
    // Replace with your actual API call
    const fetchUnreadSenders = async () => {
      const response = await fetch("/api/unreadSenders");
      const data = await response.json();
      setUnreadSenders(data);
    };
    fetchUnreadSenders();
  }, []);

const handleSelectStudent = async (s) => {
  setLoading(true);
  try {
    // 1Ô∏è‚É£ Fetch user info
    const userRes = await axios.get(
      `https://ethiostore-17d9f-default-rtdb.firebaseio.com/Users/${s.userId}.json`
    );
    const user = userRes.data || {};

    // 2Ô∏è‚É£ Fetch ClassMarks from Firebase
    const marksRes = await axios.get(
      `https://ethiostore-17d9f-default-rtdb.firebaseio.com/ClassMarks.json`
    );
    const classMarks = marksRes.data || {};

    const studentMarks = {};
    const courseTeacherMap = {};

    // Loop through all courses
    Object.entries(classMarks).forEach(([courseId, studentsObj]) => {
      const studentMark = studentsObj?.[s.studentId];
      if (studentMark) {
        studentMarks[courseId] = {
          mark20: Number(studentMark.mark20 || 0),
          mark30: Number(studentMark.mark30 || 0),
          mark50: Number(studentMark.mark50 || 0),
          teacherName: studentMark.teacherName || "Teacher",
        };
        courseTeacherMap[courseId] = studentMark.teacherName || "Teacher";
      }
    });

    // 3Ô∏è‚É£ Fetch Attendance (optional)
    const attendanceRes = await axios.get(
      `https://ethiostore-17d9f-default-rtdb.firebaseio.com/Attendance.json`
    );
    const attendanceRaw = attendanceRes.data || {};

    const attendanceData = [];
    Object.entries(attendanceRaw).forEach(([courseId, datesObj]) => {
      Object.entries(datesObj || {}).forEach(([date, studentsObj]) => {
        const status = studentsObj?.[s.studentId];
        if (status) {
          attendanceData.push({
            courseId,
            date,
            status,
            teacherName: courseTeacherMap[courseId] || "Teacher",
          });
        }
      });
    });

    // 4Ô∏è‚É£ Set selected student state
    setSelectedStudent({
      ...s,
      ...user,
      marks: studentMarks,
      attendance: attendanceData,
    });

  } catch (err) {
    console.error("Error fetching student data:", err);
  }

  setLoading(false);
};





useEffect(() => {
  const fetchTeachersAndUnread = async () => {
    try {
      const [teachersRes, usersRes] = await Promise.all([
        axios.get("https://ethiostore-17d9f-default-rtdb.firebaseio.com/Teachers.json"),
        axios.get("https://ethiostore-17d9f-default-rtdb.firebaseio.com/Users.json")
      ]);

      const teachersData = teachersRes.data || {};
      const usersData = usersRes.data || {};

      const teacherList = Object.keys(teachersData).map(tid => {
        const teacher = teachersData[tid];
        const user = usersData[teacher.userId] || {};
        return {
          teacherId: tid,
          userId: teacher.userId,
          name: user.name || "No Name",
          profileImage: user.profileImage || "/default-profile.png"
        };
      });

      setTeachers(teacherList);

      // fetch unread messages
      const unread = {};
      const allMessages = [];

      for (const t of teacherList) {
        const chatKey = `${t.userId}_${adminUserId}`;
        const res = await axios.get(`https://ethiostore-17d9f-default-rtdb.firebaseio.com/Chats/${chatKey}/messages.json`);
        const msgs = Object.values(res.data || {}).map(m => ({
          ...m,
          sender: m.senderId === adminUserId ? "admin" : "teacher"
        }));
        allMessages.push(...msgs);

        const unreadCount = msgs.filter(m => m.receiverId === adminUserId && !m.seen).length;
        if (unreadCount > 0) unread[t.userId] = unreadCount;
      }

      setPopupMessages(allMessages);
      setUnreadTeachers(unread);

    } catch (err) {
      console.error(err);
    }
  };

  fetchTeachersAndUnread();
}, [adminUserId]);

  // ------------------ FETCH STUDENTS ------------------
  useEffect(() => {
    const fetchStudents = async () => {
      try {
        const studentsRes = await axios.get("https://ethiostore-17d9f-default-rtdb.firebaseio.com/Students.json");
        const usersRes = await axios.get("https://ethiostore-17d9f-default-rtdb.firebaseio.com/Users.json");

        const studentsData = studentsRes.data || {};
        const usersData = usersRes.data || {};

        const studentList = Object.keys(studentsData).map((id) => {
          const student = studentsData[id];
          const user = usersData[student.userId] || {};
         return {
  studentId: id,
  userId: student.userId, // <-- Add this
  name: user.name || user.username || "No Name",
  profileImage: user.profileImage || "/default-profile.png",
  grade: student.grade,
  section: student.section,
  email: user.email || ""
};

        });

        setStudents(studentList);
      } catch (err) {
        console.error("Error fetching students:", err);
      }
    };

    fetchStudents();
  }, []);

  // ------------------ UPDATE SECTIONS WHEN GRADE CHANGES ------------------
  useEffect(() => {
    if (selectedGrade === "All") {
      setSections([]);
    } else {
      const gradeSections = [...new Set(students.filter(s => s.grade === selectedGrade).map(s => s.section))];
      setSections(gradeSections);
      setSelectedSection("All");
    }
  }, [selectedGrade, students]);

  // ------------------ FILTER STUDENTS ------------------
  const filteredStudents = students.filter(s => {
    if (selectedGrade !== "All" && s.grade !== selectedGrade) return false;
    if (selectedSection !== "All" && s.section !== selectedSection) return false;
    return true;
  });


 // ---------------- FETCH PERFORMANCE ----------------
useEffect(() => {
  if (!selectedStudent?.studentId) return;

  async function fetchMarks() {
    try {
      const res = await axios.get(
        "https://ethiostore-17d9f-default-rtdb.firebaseio.com/ClassMarks.json"
      );

      const marks = {};

      Object.entries(res.data || {}).forEach(([courseId, students]) => {
        if (students[selectedStudent.studentId]) {
          marks[courseId] = students[selectedStudent.studentId];
        }
      });

      setStudentMarks(marks);
    } catch (err) {
      console.error("Marks fetch error:", err);
      setStudentMarks({});
    }
  }

  fetchMarks();
}, [selectedStudent]);



//-------------------------Fetch unread status for each student--------------

  useEffect(() => {
  const fetchUnread = async () => {
    const map = {};

    for (const s of students) {
      const key = `${s.studentId}_${admin.userId}`;

      const res = await axios.get(
        `https://ethiostore-17d9f-default-rtdb.firebaseio.com/Chats/${key}/messages.json`
      );

      const msgs = res.data || {};
   map[s.studentId] = Object.values(msgs).some(
  m => m.senderId === s.studentId && m.seenByAdmin === false
);

    }

    setUnreadMap(map);
  };

  if (students.length > 0) fetchUnread();
}, [students]);

// ---------------- FETCH CHAT MESSAGES ----------------
 useEffect(() => {
  if (!studentChatOpen || !selectedStudent) return;

  const chatKey = `${selectedStudent.userId}_${adminUserId}`;

  const fetchMessages = async () => {
    try {
      const res = await axios.get(
        `https://ethiostore-17d9f-default-rtdb.firebaseio.com/Chats/${chatKey}/messages.json`
      );

      const msgs = Object.values(res.data || {}).map(m => ({
        ...m,
        sender: m.senderId === adminUserId ? "admin" : "student"
      })).sort((a, b) => a.timeStamp - b.timeStamp);

      setPopupMessages(msgs);
    } catch (err) {
      console.error(err);
    }
  };

  

  fetchMessages();
}, [studentChatOpen, selectedStudent, adminUserId]);





  // ---------------- SEND MESSAGE ----------------
const sendPopupMessage = async () => {
  if (!popupInput.trim() || !selectedStudent) return;

  const newMessage = {
    senderId: adminUserId,
    receiverId: selectedStudent.userId,
    text: popupInput,
    timeStamp: Date.now(),
    seen: false
  };

  try {
    const chatKey = `${selectedStudent.userId}_${adminUserId}`;
    await axios.post(
      `https://ethiostore-17d9f-default-rtdb.firebaseio.com/Chats/${chatKey}/messages.json`,
      newMessage
    );

    setPopupMessages(prev => [...prev, { ...newMessage, sender: "admin" }]);
    setPopupInput("");
  } catch (err) {
    console.error(err);
  }
};


 // ---------------- FETCH UNREAD MESSAGES ----------------
const fetchUnreadMessages = async () => {
  if (!admin.userId) return;

  const senders = {};

  try {
    // 1Ô∏è‚É£ USERS (names & images)
    const usersRes = await axios.get(
      "https://ethiostore-17d9f-default-rtdb.firebaseio.com/Users.json"
    );
    const usersData = usersRes.data || {};

 const findUserByUserId = (userId) => {
  return Object.values(usersData).find(u => u.userId === userId);
};



    // helper to read messages from BOTH chat keys
    const getUnreadCount = async (userId) => {
      const key1 = `${admin.userId}_${userId}`;
      const key2 = `${userId}_${admin.userId}`;

      const [r1, r2] = await Promise.all([
        axios.get(`https://ethiostore-17d9f-default-rtdb.firebaseio.com/Chats/${key1}/messages.json`),
        axios.get(`https://ethiostore-17d9f-default-rtdb.firebaseio.com/Chats/${key2}/messages.json`)
      ]);

      const msgs = [
        ...Object.values(r1.data || {}),
        ...Object.values(r2.data || {})
      ];

      return msgs.filter(
        m => m.receiverId === admin.userId && !m.seen
      ).length;
    };

    // 2Ô∏è‚É£ TEACHERS
    const teachersRes = await axios.get(
      "https://ethiostore-17d9f-default-rtdb.firebaseio.com/Teachers.json"
    );

    for (const k in teachersRes.data || {}) {
      const t = teachersRes.data[k];
      const unread = await getUnreadCount(t.userId);

      if (unread > 0) {
       const user = findUserByUserId(t.userId);

senders[t.userId] = {
  type: "teacher",
  name: user?.name || "Teacher",
  profileImage: user?.profileImage || "/default-profile.png",
  count: unread
};
      }
    }

    // 3Ô∏è‚É£ STUDENTS
    const studentsRes = await axios.get(
      "https://ethiostore-17d9f-default-rtdb.firebaseio.com/Students.json"
    );

    for (const k in studentsRes.data || {}) {
      const s = studentsRes.data[k];
      const unread = await getUnreadCount(s.userId);

      if (unread > 0) {
        const user = findUserByUserId(s.userId);

senders[s.userId] = {
  type: "student",
  name: user?.name || s.name || "Student",
  profileImage: user?.profileImage || s.profileImage || "/default-profile.png",
  count: unread
};

      }
    }

    // 4Ô∏è‚É£ PARENTS
    const parentsRes = await axios.get(
      "https://ethiostore-17d9f-default-rtdb.firebaseio.com/Parents.json"
    );

    for (const k in parentsRes.data || {}) {
      const p = parentsRes.data[k];
      const unread = await getUnreadCount(p.userId);

      if (unread > 0) {
       const user = findUserByUserId(p.userId);

senders[p.userId] = {
  type: "parent",
  name: user?.name || p.name || "Parent",
  profileImage: user?.profileImage || p.profileImage || "/default-profile.png",
  count: unread
};

      }
    }

    setUnreadSenders(senders);
  } catch (err) {
    console.error("Unread fetch failed:", err);
  }
};

  // ---------------- CLOSE DROPDOWN ON OUTSIDE CLICK ----------------
useEffect(() => {
  const closeDropdown = (e) => {
    if (
      !e.target.closest(".icon-circle") &&
      !e.target.closest(".messenger-dropdown")
    ) {
      setShowMessageDropdown(false);
    }
  };

  document.addEventListener("click", closeDropdown);
  return () => document.removeEventListener("click", closeDropdown);
}, []);


useEffect(() => {
  if (!admin.userId) return;

  fetchUnreadMessages();
  const interval = setInterval(fetchUnreadMessages, 5000);

  return () => clearInterval(interval);
}, [admin.userId]);



  // ---------------- MARK MESSAGES AS SEEN ----------------
  useEffect(() => {
    if (!studentChatOpen || !selectedStudent) return;

    const markSeen = async () => {
      const chatKey = `${adminUserId}_${selectedStudent.userId}`;
      try {
        const res = await axios.get(`https://ethiostore-17d9f-default-rtdb.firebaseio.com/Chats/${chatKey}/messages.json`);
        const msgs = Object.entries(res.data || {});
        const updates = {};
        msgs.forEach(([key, msg]) => {
          if (msg.receiverId === adminUserId && !msg.seen) updates[key + "/seen"] = true;
        });
        if (Object.keys(updates).length > 0) {
          await axios.patch(`https://ethiostore-17d9f-default-rtdb.firebaseio.com/Chats/${chatKey}/messages.json`, updates);
          setUnreadStudents(prev => ({ ...prev, [selectedStudent.userId]: 0 }));
        }
      } catch (err) {
        console.error(err);
      }
    };
    markSeen();
  }, [studentChatOpen, selectedStudent, adminUserId]);



const attendanceStats = useMemo(() => {
  if (!selectedStudent?.attendance) return null;

  const total = selectedStudent.attendance.length;
  const present = selectedStudent.attendance.filter(a => a.status === "present").length;
  const absent = total - present;
  const percent = total ? Math.round((present / total) * 100) : 0;

  // Consecutive absences
  let streak = 0;
  [...selectedStudent.attendance]
    .sort((a, b) => b.date.localeCompare(a.date))
    .some(a => {
      if (a.status === "absent") {
        streak++;
        return false;
      }
      return true;
    });

  return { total, present, absent, percent, streak };
}, [selectedStudent]);


const markMessagesAsSeen = async (userId) => {
  const key1 = `${admin.userId}_${userId}`;
  const key2 = `${userId}_${admin.userId}`;

  const [r1, r2] = await Promise.all([
    axios.get(`https://ethiostore-17d9f-default-rtdb.firebaseio.com/Chats/${key1}/messages.json`),
    axios.get(`https://ethiostore-17d9f-default-rtdb.firebaseio.com/Chats/${key2}/messages.json`)
  ]);

  const updates = {};

  const collectUpdates = (data, basePath) => {
    Object.entries(data || {}).forEach(([msgId, msg]) => {
      if (msg.receiverId === admin.userId && !msg.seen) {
        updates[`${basePath}/${msgId}/seen`] = true;
      }
    });
  };

  collectUpdates(r1.data, `Chats/${key1}/messages`);
  collectUpdates(r2.data, `Chats/${key2}/messages`);

  if (Object.keys(updates).length > 0) {
    await axios.patch(
      "https://ethiostore-17d9f-default-rtdb.firebaseio.com/.json",
      updates
    );
  }
};

const attendanceData = React.useMemo(() => {
  if (!selectedStudent?.attendance) return [];

  return selectedStudent.attendance.map(a => ({
    date: a.date || a.created_at,
    courseId: a.courseId || a.course || "Unknown Course",
    teacherName: a.teacherName || a.teacher || "Unknown Teacher",
    status: a.status || a.attendance_status || "absent"
  }));
}, [selectedStudent]);

const groupedAttendance = React.useMemo(() => {
  if (!attendanceData.length) return {};

  return attendanceData.reduce((acc, record) => {
    const dateKey = new Date(record.date).toLocaleDateString();

    if (!acc[dateKey]) acc[dateKey] = [];
    acc[dateKey].push(record);

    return acc;
  }, {});
}, [attendanceData]);


const toggleExpand = (key) => {
  setExpandedCards((prev) => ({
    ...prev,
    [key]: !prev[key],
  }));
};

const getProgress = (records) => {
  if (!records || !records.length) return 0;
  const presentCount = records.filter(
    (r) => r.status === "present" || r.status === "late"
  ).length;
  return Math.round((presentCount / records.length) * 100);
};

const attendanceBySubject = attendanceData.reduce((acc, cur) => {
  if (!acc[cur.courseId]) acc[cur.courseId] = [];
  acc[cur.courseId].push(cur);
  return acc;
}, {});

const formatSubjectName = (courseId = "") => {
  const clean = courseId
    .replace("course_", "")
    .replace(/_[0-9A-Za-z]+$/, "") // remove class like _9A
    .replace(/_/g, " ");

  return clean.charAt(0).toUpperCase() + clean.slice(1);
};


  return (
    <div className="dashboard-page">

      {/* ---------------- TOP NAVIGATION BAR ---------------- */}
      <nav className="top-navbar">
        <h2>Gojo Dashboard</h2>
        <div className="nav-search">
          <FaSearch className="search-icon" />
          <input type="text" placeholder="Search Teacher and Student..." />
        </div>
        <div className="nav-right">
          <div
  className="icon-circle"
  style={{ position: "relative", cursor: "pointer" }}
  onClick={(e) => {
    e.stopPropagation();
    setShowPostDropdown(prev => !prev);
  }}
>
  <FaBell />

  {/* üî¥ Notification Count */}
  {postNotifications.length > 0 && (
    <span
      style={{
        position: "absolute",
        top: "-5px",
        right: "-5px",
        background: "red",
        color: "#fff",
        borderRadius: "50%",
        padding: "2px 6px",
        fontSize: "10px",
        fontWeight: "bold"
      }}
    >
      {postNotifications.length}
    </span>
  )}

  {/* üîî Notification Dropdown */}
  {showPostDropdown && (
    <div
      className="notification-dropdown"
      style={{
        position: "absolute",
        top: "40px",
        right: "0",
        width: "350px",
        maxHeight: "400px",
        overflowY: "auto",
        background: "#fff",
        borderRadius: "10px",
        boxShadow: "0 4px 15px rgba(0,0,0,0.25)",
        zIndex: 1000
      }}
      onClick={(e) => e.stopPropagation()}
    >
      {postNotifications.length === 0 ? (
        <p style={{ padding: "12px", textAlign: "center" }}>
          No new notifications
        </p>
      ) : (
        postNotifications.map(n => (
          <div
            key={n.notificationId}
            style={{
              display: "flex",
              gap: "10px",
              padding: "10px",
              cursor: "pointer",
              borderBottom: "1px solid #eee"
            }}
            onClick={() => handleNotificationClick(n)}
          >
            <img
              src={n.adminProfile || "/default-profile.png"}
              alt={n.adminName}
              style={{
                width: "40px",
                height: "40px",
                borderRadius: "50%"
              }}
            />
            <div>
              <strong>{n.adminName}</strong>
              <p style={{ margin: 0 }}>{n.message}</p>
            </div>
          </div>
        ))
      )}
    </div>
  )}
</div>

    {/* ================= MESSENGER ================= */}
    <div
      className="icon-circle"
      style={{ position: "relative", cursor: "pointer" }}
      onClick={(e) => {
        e.stopPropagation();
        setShowMessageDropdown((prev) => !prev);
      }}
    >
      <FaFacebookMessenger />
    
      {/* üî¥ TOTAL UNREAD COUNT */}
      {Object.keys(unreadSenders).length > 0 && (
        <span
          style={{
            position: "absolute",
            top: "-5px",
            right: "-5px",
            background: "red",
            color: "#fff",
            borderRadius: "50%",
            padding: "2px 6px",
            fontSize: "10px",
            fontWeight: "bold"
          }}
        >
          {Object.values(unreadSenders).reduce((a, b) => a + b.count, 0)}
        </span>
      )}
    
      {/* üì© DROPDOWN */}
      {showMessageDropdown && (
        <div
          style={{
            position: "absolute",
            top: "40px",
            right: "0",
            width: "300px",
            background: "#fff",
            borderRadius: "10px",
            boxShadow: "0 4px 15px rgba(0,0,0,0.25)",
            zIndex: 1000
          }}
        >
          {Object.keys(unreadSenders).length === 0 ? (
            <p style={{ padding: "12px", textAlign: "center", color: "#777" }}>
              No new messages
            </p>
          ) : (
            Object.entries(unreadSenders).map(([userId, sender]) => (
              <div
                key={userId}
                style={{
                  padding: "12px",
                  display: "flex",
                  alignItems: "center",
                  gap: "10px",
                  cursor: "pointer",
                  borderBottom: "1px solid #eee"
                }}
              onClick={async () => {
  setShowMessageDropdown(false);

  // 1Ô∏è‚É£ Mark messages as seen in DB
  await markMessagesAsSeen(userId);

  // 2Ô∏è‚É£ Remove sender immediately from UI
  setUnreadSenders(prev => {
    const copy = { ...prev };
    delete copy[userId];
    return copy;
  });

  // 3Ô∏è‚É£ Navigate to exact chat
  navigate("/all-chat", {
    state: {
      user: {
        userId,
        name: sender.name,
        profileImage: sender.profileImage,
        type: sender.type
      }
    }
  });
}}

    
    
              >
                <img
                  src={sender.profileImage}
                  alt={sender.name}
                  style={{
                    width: "42px",
                    height: "42px",
                    borderRadius: "50%"
                  }}
                />
                <div>
                  <strong>{sender.name}</strong>
                  <p style={{ fontSize: "12px", margin: 0 }}>
                    {sender.count} new message{sender.count > 1 && "s"}
                  </p>
                </div>
              </div>
            ))
          )}
        </div>
      )}
    </div>
    {/* ============== END MESSENGER ============== */}
    

           <Link className="icon-circle" to="/settings">
                           <FaCog />
                         </Link>
          <img src={admin.profileImage || "/default-profile.png"} alt="admin" className="profile-img" />
        </div>
      </nav>

      {/* ---------------- DASHBOARD LAYOUT ---------------- */}
      <div className="google-dashboard" style={{ display: "flex" }}>

        {/* ---------------- SIDEBAR ---------------- */}
        <div className="google-sidebar">
          <div className="sidebar-profile">
            <div className="sidebar-img-circle">
              <img src={admin.profileImage || "/default-profile.png"} alt="profile" />
            </div>
            <h3>{admin.name}</h3>
            <p>{admin.username}</p>
          </div>

          <div className="sidebar-menu">
                     <Link className="sidebar-btn" to="/dashboard"
                      
                      > <FaHome style={{ width: "28px", height:"28px" }}/> Home</Link>
                       <Link className="sidebar-btn" to="/my-posts"><FaFileAlt /> My Posts</Link>
                       <Link className="sidebar-btn" to="/teachers"><FaChalkboardTeacher /> Teachers</Link>
                         <Link className="sidebar-btn" to="/students" style={{ backgroundColor: "#4b6cb7", color: "#fff" }}> <FaChalkboardTeacher /> Students</Link>
                          <Link
                                       className="sidebar-btn"
                                       to="/schedule"
                                       
                                     >
                                       <FaCalendarAlt /> Schedule
                                     </Link>
                          <Link className="sidebar-btn" to="/parents" ><FaChalkboardTeacher /> Parents
                                     </Link>
                                               
                   
                       <button
                         className="sidebar-btn logout-btn"
                         onClick={() => {
                           localStorage.removeItem("admin");
                           window.location.href = "/login";
                         }}
                       >
                         <FaSignOutAlt /> Logout
                       </button>
                     </div>
        </div>

        {/* ---------------- MAIN CONTENT ---------------- */}
        <div className="main-content" style={{ padding: "30px", width: "65%", marginLeft: "200px" }}>
          <h2 style={{ marginBottom: "20px", textAlign: "center" }}>Students</h2>

          {/* Grade Filter */}
          <div style={{ display: "flex", justifyContent: "center", marginBottom: "25px", gap: "12px" }}>
            {["All", "9", "10", "11", "12"].map(g => (
              <button key={g} onClick={() => setSelectedGrade(g)} style={{
                padding: "10px 20px",
                borderRadius: "8px",
                background: selectedGrade === g ? "#4b6cb7" : "#ddd",
                color: selectedGrade === g ? "#fff" : "#000",
                cursor: "pointer",
                border: "none",
              }}>
                {g === "All" ? "All Grades" : `Grade ${g}`}
              </button>
            ))}
          </div>

          {/* Section Filter */}
          {selectedGrade !== "All" && sections.length > 0 && (
            <div style={{ display: "flex", justifyContent: "center", marginBottom: "25px", gap: "12px", }}>
              {["All", ...sections].map(section => (
                <button key={section} onClick={() => setSelectedSection(section)} style={{
                  padding: "8px 16px",
                  borderRadius: "8px",
                  background: selectedSection === section ? "#4b6cb7" : "#ddd",
                  color: selectedSection === section ? "#fff" : "#000",
                  cursor: "pointer",
                  border: "none",
                }}>
                  {section === "All" ? "All Sections" : `Section ${section}`}
                </button>
              ))}
            </div>
          )}

          {/* Students List */}
          {filteredStudents.length === 0 ? (
            <p style={{ textAlign: "center", color: "#555" }}>No students found for this selection.</p>
          ) : (
            <div style={{ display: "flex", flexDirection: "column", alignItems: "center", gap: "20px" }}>
             {filteredStudents.map(s => (
  <div
    key={s.userId}
    onClick={() => handleSelectStudent(s)}
    style={{
      width: "700px",
      height: "100px",
      borderRadius: "12px",
      padding: "15px",
      background: selectedStudent?.studentId === s.studentId ? "#e0e7ff" : "#fff",
      border: selectedStudent?.studentId === s.studentId ? "2px solid #4b6cb7" : "1px solid #ddd",
      display: "flex",
      alignItems: "center",
      gap: "20px",
      cursor: "pointer"
    }}
  >
    <img src={s.profileImage} alt={s.name} style={{ width: "50px", height: "50px", borderRadius: "50%", objectFit: "cover" }} />
    <div>
      <h3 style={{ margin: 0 }}>{s.name}</h3>
      <p style={{ margin: "4px 0", color: "#555" }}>Grade {s.grade} - Section {s.section}</p>
    </div>
  </div>
))}

            </div>
          )}
        </div>

        {/* ---------------- RIGHT SIDEBAR FOR SELECTED STUDENT ---------------- */}
       {/* ---------------- RIGHT SIDEBAR FOR SELECTED STUDENT ---------------- */}
{selectedStudent && (
  <div style={{
    width: "30%",
    height: "100vh",
    display: "flex",
    flexDirection: "column",
    position: "fixed",
    right: 0,
    top: 0,
    background: "#fff",
    boxShadow: "0 0 15px rgba(0,0,0,0.05)",
    zIndex: 10
  }}>
    {/* Scrollable content */}
    <div style={{ overflowY: "auto", padding: "25px", flex: 1 }}>
      {/* Student Info */}
      <div style={{ textAlign: "center", marginBottom: "20px" }}>
        <div style={{
          background: "#becff7ff",
          padding: "25px 10px",
          height: "200px",
          margin: "50px 1px 20px",
          boxShadow: "0 4px 15px rgba(0,0,0,0.1)"
        }}>
          <div style={{
            width: "100px",
            height: "100px",
            margin: "-20px auto 15px",
            borderRadius: "50%",
            overflow: "hidden",
            border: "4px solid #4b6cb7",
            boxShadow: "0 4px 15px rgba(0,0,0,0.1)"
          }}>
            <img src={selectedStudent.profileImage} alt={selectedStudent.name} style={{ width: "100%", height: "100%", objectFit: "cover" }} />
          </div>
          <h2 style={{ margin: 0, fontSize: "22px", marginTop: "-10px", color: "#333" }}>{selectedStudent.name}</h2>
          <h2 style={{ margin: 0, fontSize: "16px", color: "#585656ff" }}>{selectedStudent.email || "default.student@example.com"}</h2>
        </div>
        <p><strong>Grade:</strong> {selectedStudent.grade}</p>
        <p><strong>Section:</strong> {selectedStudent.section}</p>
      </div>

      {/* Tabs */}
      <div style={{ marginBottom: "20px" }}>
        <div style={{ display: "flex", marginBottom: "10px", borderBottom: "1px solid #eee" }}>
          {["details", "attendance", "performance"].map(tab => (
            <button
              key={tab}
              onClick={() => setStudentTab(tab)}
              style={{
                flex: 1,
                padding: "10px",
                border: "none",
                background: "none",
                cursor: "pointer",
                fontWeight: "600",
                color: studentTab === tab ? "#4b6cb7" : "#777",
                borderBottom: studentTab === tab ? "3px solid #4b6cb7" : "3px solid transparent",
              }}
            >
              {tab.toUpperCase()}
            </button>
          ))}
        </div>

        {loading ? (
          <p style={{ textAlign: "center", color: "#888" }}>Loading...</p>
        ) : (
          <>
            {/* DETAILS TAB */}
  {/* ================= DETAILS TAB ================= */}
{studentTab === "details" && selectedStudent && (
  <div style={{
    padding: "26px",
    maxHeight: "70vh",
    overflowY: "auto",
    background: "#f9fafb",
    borderRadius: "20px"
  }}>
    {/* Sticky Header */}
    <div style={{
      position: "sticky",
      top: 0,
      background: "#f9fafb",
      paddingBottom: "16px",
      zIndex: 10,
      borderBottom: "1px solid #e5e7eb"
    }}>
      <h2 style={{ fontSize: "22px", fontWeight: "900", color: "#2563eb", letterSpacing: "0.5px" }}>
        üë§ Student Information
      </h2>
    </div>

    {/* Student Info Grid */}
    <div style={{
      display: "grid",
      gridTemplateColumns: "1fr 1fr",
      gap: "20px",
      marginTop: "20px"
    }}>
      {/* Email */}
      <div style={{
        background: "#fff",
        borderRadius: "16px",
        padding: "16px",
        boxShadow: "0 4px 15px rgba(0,0,0,0.05)"
      }}>
        <div style={{ fontSize: "14px", color: "#64748b" }}>üìß Email</div>
        <div style={{ fontSize: "16px", fontWeight: "700", color: "#111" }}>
          {selectedStudent.email || "N/A"}
        </div>
      </div>

      {/* Age */}
      <div style={{
        background: "#fff",
        borderRadius: "16px",
        padding: "16px",
        boxShadow: "0 4px 15px rgba(0,0,0,0.05)"
      }}>
        <div style={{ fontSize: "14px", color: "#64748b" }}>üéÇ Age</div>
        <div style={{ fontSize: "16px", fontWeight: "700", color: "#111" }}>
          {selectedStudent.age || "N/A"}
        </div>
      </div>

      {/* Parent Name */}
      <div style={{
        background: "#fff",
        borderRadius: "16px",
        padding: "16px",
        boxShadow: "0 4px 15px rgba(0,0,0,0.05)"
      }}>
        <div style={{ fontSize: "14px", color: "#64748b" }}>üë®‚Äçüë©‚Äçüëß Parent Name</div>
        <div style={{ fontSize: "16px", fontWeight: "700", color: "#111" }}>
          {selectedStudent.parentName || "N/A"}
        </div>
      </div>

      {/* Parent Phone */}
      <div style={{
        background: "#fff",
        borderRadius: "16px",
        padding: "16px",
        boxShadow: "0 4px 15px rgba(0,0,0,0.05)"
      }}>
        <div style={{ fontSize: "14px", color: "#64748b" }}>üì± Parent Phone</div>
        <div style={{ fontSize: "16px", fontWeight: "700", color: "#111" }}>
          {selectedStudent.parentPhone || "N/A"}
        </div>
      </div>

      {/* Grade */}
      <div style={{
        background: "#fff",
        borderRadius: "16px",
        padding: "16px",
        boxShadow: "0 4px 15px rgba(0,0,0,0.05)"
      }}>
        <div style={{ fontSize: "14px", color: "#64748b" }}>üè´ Grade</div>
        <div style={{ fontSize: "16px", fontWeight: "700", color: "#111" }}>
          {selectedStudent.grade || "N/A"}
        </div>
      </div>

      {/* Section */}
      <div style={{
        background: "#fff",
        borderRadius: "16px",
        padding: "16px",
        boxShadow: "0 4px 15px rgba(0,0,0,0.05)"
      }}>
        <div style={{ fontSize: "14px", color: "#64748b" }}>üìö Section</div>
        <div style={{ fontSize: "16px", fontWeight: "700", color: "#111" }}>
          {selectedStudent.section || "N/A"}
        </div>
      </div>

      {/* Additional Features */}
      {/* e.g., Student ID */}
      <div style={{
        background: "#f0f9ff",
        borderRadius: "16px",
        padding: "16px",
        boxShadow: "0 4px 15px rgba(0,0,0,0.05)"
      }}>
        <div style={{ fontSize: "14px", color: "#2563eb" }}>üÜî Student ID</div>
        <div style={{ fontSize: "16px", fontWeight: "700", color: "#111" }}>
          {selectedStudent.studentId || "N/A"}
        </div>
      </div>

      {/* e.g., Extra Feature: Notes */}
      <div style={{
        background: "#fff7ed",
        borderRadius: "16px",
        padding: "16px",
        boxShadow: "0 4px 15px rgba(0,0,0,0.05)"
      }}>
        <div style={{ fontSize: "14px", color: "#ea580c" }}>üìù Notes</div>
        <div style={{ fontSize: "16px", fontWeight: "700", color: "#111" }}>
          {selectedStudent.notes || "No notes available"}
        </div>
      </div>

    </div>
  </div>
)}

{/* ================= ATTENDANCE TAB ================= */}
{studentTab === "attendance" && selectedStudent && (
  <div
    style={{
      padding: 30,
      background: "radial-gradient(circle at top,#eef2ff,#f8fafc)",
      borderRadius: 26,
      fontFamily: "Inter, system-ui",
    }}
  >
    {/* ===== VIEW SWITCH ===== */}
    <div
      style={{
        display: "flex",
        justifyContent: "center",
        gap: 16,
        marginBottom: 32,
      }}
    >
      {["daily", "weekly", "monthly"].map((v) => (
        <button
          key={v}
          onClick={() => setAttendanceView(v)}
          style={{
            padding: "12px 28px",
            borderRadius: 999,
            border: "none",
            fontWeight: 800,
            fontSize: 13,
            letterSpacing: 1,
            cursor: "pointer",
            background:
              attendanceView === v
                ? "linear-gradient(135deg,#4f46e5,#2563eb)"
                : "rgba(255,255,255,.8)",
            color: attendanceView === v ? "#fff" : "#1f2937",
            boxShadow:
              attendanceView === v
                ? "0 18px 40px rgba(79,70,229,.45)"
                : "0 6px 14px rgba(0,0,0,.08)",
            transition: "all .3s ease",
          }}
        >
          {v.toUpperCase()}
        </button>
      ))}
    </div>

    {/* ===== SUBJECT CARDS ===== */}
    {Object.entries(attendanceBySubject)
      .filter(
        ([course]) =>
          attendanceCourseFilter === "All" || course === attendanceCourseFilter
      )
      .map(([course, records]) => {
        const today = new Date().toDateString();
        const weekRecords = records.filter(
          (r) => new Date(r.date).getWeek?.() === new Date().getWeek?.()
        );
        const monthRecords = records.filter(
          (r) => new Date(r.date).getMonth() === new Date().getMonth()
        );

        const displayRecords =
          attendanceView === "daily"
            ? records.filter((r) => new Date(r.date).toDateString() === today)
            : attendanceView === "weekly"
            ? weekRecords
            : monthRecords;

        const progress = getProgress(displayRecords);
        const expandKey = `${attendanceView}-${course}`;

        return (
          <div
            key={course}
            style={{
              background:
                "linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.85))",
              backdropFilter: "blur(14px)",
              borderRadius: 26,
              padding: 26,
              marginBottom: 26,
              boxShadow: "0 30px 60px rgba(0,0,0,.12)",
              position: "relative",
              overflow: "hidden",
            }}
          >
            {/* Glow */}
            <div
              style={{
                position: "absolute",
                inset: 0,
                background:
                  "radial-gradient(circle at top left,rgba(99,102,241,.15),transparent 60%)",
                pointerEvents: "none",
              }}
            />

            {/* HEADER */}
            <div
              style={{
                display: "flex",
                justifyContent: "space-between",
                alignItems: "center",
                marginBottom: 18,
              }}
            >
              <div>
                <h3
                  style={{
                    margin: 0,
                    fontSize: 20,
                    fontWeight: 900,
                    color: "#1e3a8a",
                  }}
                >
                  üìö {formatSubjectName(course)}
                </h3>
                <p
                  style={{
                    margin: "6px 0 0",
                    fontSize: 13,
                    color: "#64748b",
                  }}
                >
                  üë®‚Äçüè´ {records[0]?.teacherName}
                </p>
              </div>

              <div
                style={{
                  padding: "8px 16px",
                  borderRadius: 999,
                  fontSize: 13,
                  fontWeight: 900,
                  background:
                    progress >= 75
                      ? "linear-gradient(135deg,#22c55e,#16a34a)"
                      : progress >= 50
                      ? "linear-gradient(135deg,#facc15,#eab308)"
                      : "linear-gradient(135deg,#ef4444,#dc2626)",
                  color: "#fff",
                  boxShadow: "0 10px 25px rgba(0,0,0,.25)",
                }}
              >
                {progress}%
              </div>
            </div>

            {/* PROGRESS BAR */}
            <div
              onClick={() => toggleExpand(expandKey)}
              style={{
                height: 16,
                background: "#e5e7eb",
                borderRadius: 999,
                cursor: "pointer",
                overflow: "hidden",
                marginBottom: 10,
              }}
            >
              <div
                style={{
                  height: "100%",
                  width: `${progress}%`,
                  background:
                    progress >= 75
                      ? "linear-gradient(90deg,#22c55e,#16a34a)"
                      : progress >= 50
                      ? "linear-gradient(90deg,#facc15,#eab308)"
                      : "linear-gradient(90deg,#ef4444,#dc2626)",
                  transition: "width .5s cubic-bezier(.4,0,.2,1)",
                }}
              />
            </div>

            <div
              style={{
                fontSize: 12,
                fontWeight: 700,
                color: "#475569",
                marginBottom: 12,
                letterSpacing: 0.6,
              }}
            >
              CLICK BAR TO VIEW {attendanceView.toUpperCase()} DETAILS
            </div>

            {/* EXPANDED DAYS */}
            {expandedCards[expandKey] && (
              <div
                style={{
                  marginTop: 14,
                  background: "#f1f5f9",
                  borderRadius: 18,
                  padding: 14,
                }}
              >
                {displayRecords.map((r, i) => (
                  <div
                    key={i}
                    style={{
                      display: "flex",
                      justifyContent: "space-between",
                      alignItems: "center",
                      padding: "12px 8px",
                      borderBottom:
                        i !== displayRecords.length - 1
                          ? "1px solid #e5e7eb"
                          : "none",
                    }}
                  >
                    <span style={{ fontSize: 13, color: "#1f2937" }}>
                      üìÖ {new Date(r.date).toDateString()}
                    </span>

                    <span
                      style={{
                        padding: "6px 14px",
                        borderRadius: 999,
                        fontSize: 12,
                        fontWeight: 900,
                        background:
                          r.status === "present"
                            ? "#dcfce7"
                            : r.status === "late"
                            ? "#fef3c7"
                            : "#fee2e2",
                        color:
                          r.status === "present"
                            ? "#166534"
                            : r.status === "late"
                            ? "#92400e"
                            : "#991b1b",
                      }}
                    >
                      {r.status.toUpperCase()}
                    </span>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      })}
  </div>
)}






            {/* PERFORMANCE TAB */}
            {/* PERFORMANCE TAB */}
   {studentTab === "performance" && (
  <div style={{ position: "relative", paddingBottom: "70px", background: "#f8fafc" }}>
    <div
      style={{
        display: "grid",
        gridTemplateColumns: "repeat(2, 1fr)",
        gap: "20px",
        padding: "20px",
      }}
    >
      {Object.keys(studentMarks).length === 0 ? (
        <div
          style={{
            textAlign: "center",
            padding: "30px",
            borderRadius: "18px",
            background: "#ffffff",
            color: "#475569",
            fontSize: "16px",
            fontWeight: "600",
            boxShadow: "0 10px 25px rgba(0,0,0,0.08)",
          }}
        >
          üö´ No Performance Records
        </div>
      ) : (
        Object.entries(studentMarks).map(([courseId, marks], idx) => {
          const assessments = marks.assessments || {};
          const total = Object.values(assessments).reduce((sum, a) => sum + (a.score || 0), 0);
          const maxTotal = Object.values(assessments).reduce((sum, a) => sum + (a.max || 0), 0);
          const percentage = maxTotal > 0 ? (total / maxTotal) * 100 : 0;

          const statusColor =
            percentage >= 75
              ? "#16a34a"
              : percentage >= 50
              ? "#f59e0b"
              : "#dc2626";

          return (
            <div
              key={idx}
              style={{
                padding: "18px",
                borderRadius: "20px",
                background: "#ffffff",
                boxShadow: "0 12px 30px rgba(0,0,0,0.08)",
                color: "#0f172a",
                transition: "all 0.3s ease",
              }}
            >
              <div
                style={{
                  fontSize: "16px",
                  fontWeight: "800",
                  marginBottom: "14px",
                  textTransform: "capitalize",
                  color: "#2563eb",
                }}
              >
                {courseId.replace("course_", "").replace(/_/g, " ")}
              </div>

              {/* Score Circle */}
              <div style={{ display: "flex", justifyContent: "center", marginBottom: "16px" }}>
                <div
                  style={{
                    width: "90px",
                    height: "90px",
                    borderRadius: "50%",
                    background: `conic-gradient(${statusColor} ${percentage * 3.6}deg, #e5e7eb 0deg)`,
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "center",
                  }}
                >
                  <div
                    style={{
                      width: "66px",
                      height: "66px",
                      borderRadius: "50%",
                      background: "#ffffff",
                      display: "flex",
                      flexDirection: "column",
                      alignItems: "center",
                      justifyContent: "center",
                    }}
                  >
                    <div style={{ fontSize: "18px", fontWeight: "800", color: statusColor }}>
                      {total}
                    </div>
                    <div style={{ fontSize: "11px", color: "#64748b" }}>
                      / {maxTotal}
                    </div>
                  </div>
                </div>
              </div>

              {/* Marks Bars */}
              {Object.entries(assessments).map(([key, a]) => (
                <div key={key} style={{ marginBottom: "10px" }}>
                  <div
                    style={{
                      display: "flex",
                      justifyContent: "space-between",
                      fontSize: "13px",
                      fontWeight: "600",
                      color: "#334155",
                    }}
                  >
                    <span>{a.name}</span>
                    <span>
                      {a.score} / {a.max}
                    </span>
                  </div>
                  <div
                    style={{
                      height: "6px",
                      borderRadius: "999px",
                      background: "#e5e7eb",
                      marginTop: "5px",
                      overflow: "hidden",
                    }}
                  >
                    <div
                      style={{
                        width: `${(a.score / a.max) * 100}%`,
                        height: "100%",
                        background:
                          a.max >= 50
                            ? "#ea580c"
                            : a.max >= 30
                            ? "#16a34a"
                            : "#2563eb",
                      }}
                    />
                  </div>
                </div>
              ))}

              {/* Status */}
              <div
                style={{
                  marginTop: "12px",
                  textAlign: "center",
                  fontSize: "13px",
                  fontWeight: "700",
                  color: statusColor,
                }}
              >
                {percentage >= 75
                  ? "Excellent"
                  : percentage >= 50
                  ? "Good"
                  : "Needs Improvement"}
              </div>

              {/* Teacher */}
              <div
                style={{
                  marginTop: "6px",
                  textAlign: "center",
                  fontSize: "12px",
                  color: "#64748b",
                }}
              >
                üë®‚Äçüè´ {marks.teacherName}
              </div>
            </div>
          );
        })
      )}
    </div>
  </div>
)}
          </>
        )}
      </div>
    </div>

    {/* ---------------- MESSAGE BUTTON (rigid) ---------------- */}
   {/* ================= FIXED MESSAGE BUTTON ================= */}
   <div
     onClick={() => setStudentChatOpen(true)}
     style={{
       position: "fixed",        // üîí RIGID
       bottom: "20px",
       right: "20px",
       width: "48px",
       height: "48px",
       background:
         "linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045)",
       borderRadius: "50%",
       display: "flex",
       alignItems: "center",
       justifyContent: "center",
       color: "#fff",
       cursor: "pointer",
       zIndex: 9999,
       boxShadow: "0 8px 18px rgba(0,0,0,0.25)",
       transition: "transform 0.2s ease, box-shadow 0.2s ease",
     }}
     onMouseEnter={(e) => {
       e.currentTarget.style.transform = "scale(1.08)";
       e.currentTarget.style.boxShadow =
         "0 12px 26px rgba(0,0,0,0.35)";
     }}
     onMouseLeave={(e) => {
       e.currentTarget.style.transform = "scale(1)";
       e.currentTarget.style.boxShadow =
         "0 8px 18px rgba(0,0,0,0.25)";
     }}
   >
     <FaCommentDots size={22} />
   </div>
   
  </div>
)}
{/* ================= STUDENT CHAT POPUP ================= */}
{studentChatOpen && selectedStudent && (
  <div style={{
    position: "fixed",
    bottom: "6px",
    right: "22px",
    width: "320px",
    background: "#fff",
    borderRadius: "12px",
    boxShadow: "0 8px 25px rgba(0,0,0,0.15)",
    padding: "15px",
    zIndex: 999,
    animation: "fadeIn 0.3s ease"
  }}>
    {/* Header */}
    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", borderBottom: "1px solid #ddd", paddingBottom: "10px" }}>
      <strong>{selectedStudent.name}</strong>
      <div style={{ display: "flex", gap: "10px" }}>
        {/* Expand Button */}
     <button
  onClick={() => {
    setStudentChatOpen(false);
    navigate("/all-chat", { 
      state: { 
        user: { 
          userId: selectedStudent.userId,  // ‚úÖ Correct userId
          name: selectedStudent.name, 
          profileImage: selectedStudent.profileImage || "/default-profile.png" 
        }, 
        userType: "student" 
      } 
    });
  }}
>

          <img width="30" height="30" src="https://img.icons8.com/ios-glyphs/30/expand--v1.png" alt="expand" />
        </button>

        <button onClick={() => setStudentChatOpen(false)} style={{ background: "none", border: "none", fontSize: "20px", cursor: "pointer" }}>√ó</button>
      </div>
    </div>

    {/* Chat Body */}
    <div style={{ height: "260px", overflowY: "auto", padding: "10px" }}>
      {popupMessages.length === 0 ? (
        <p style={{ color: "#aaa", textAlign: "center" }}>No messages yet</p>
      ) : (
        popupMessages.map((msg) => (
          <div key={msg.id} style={{ marginBottom: "10px", textAlign: msg.senderId === admin.userId ? "right" : "left" }}>
            <span style={{
              background: msg.senderId === admin.userId ? "#4b6cb7" : "#eee",
              color: msg.senderId === admin.userId ? "#fff" : "#000",
              padding: "6px 12px",
              borderRadius: "12px",
              display: "inline-block",
              maxWidth: "80%"
            }}>
              {msg.text}
              {msg.edited && <span style={{ fontSize: "10px", opacity: 0.7 }}> (edited)</span>}
            </span>
          </div>
        ))
      )}
    </div>

    {/* Input */}
    <div style={{ display: "flex", marginTop: "8px", gap: "5px" }}>
      <input
        type="text"
        value={popupInput}
        onChange={e => setPopupInput(e.target.value)}
        onKeyDown={e => e.key === "Enter" && handleSendMessage()}
        placeholder="Type a message..."
        style={{ flex: 1, padding: "8px 12px", borderRadius: "8px", border: "1px solid #ddd" }}
      />
      <button onClick={() => sendPopupMessage(newMessageText)} style={{ background: "none", border: "none", color: "#3654dada", cursor: "pointer", fontSize: "30px" }}>‚û§</button>
    </div>
  </div>
)}

      </div>
    </div>
  );
}

export default StudentsPage;
